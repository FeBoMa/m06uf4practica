<!DOCTYPE html>
<html>
<head>
	<title>40_modals_and_APIGoogle</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">           	

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>      
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        
        <style>
        #mapid {  height: 400px;
                width: 400px;
                float: left;
                }
        #grafic {  height: 400px;
                width: 400px;
                float:right;
                }
            </style>
		
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
<script>
    //variables globals
    var lastUpdateTime = 0;    
    var frequenciaActualitzacio = 3;                           
    var interval = setInterval(consultaDades, frequenciaActualitzacio*1000);            
    
    //necesari per google charts
    google.charts.load('current', {'packages':['corechart']});      
    google.charts.setOnLoadCallback(actualitzaGrafica);
    
	
     $(document).ready(function(){                  
        
        // actualitza velocitat de refresc
        $("#myModalGuardar").click(function() {
            frequenciaActualitzacio = $("#myModalNovaFrequencia").val();
            $("#frequencia").text(frequenciaActualitzacio);
            $("#myModal").modal("hide");
            clearInterval(interval);
            interval = setInterval(consultaDades, frequenciaActualitzacio*1000);  //actualitzem dades cada quan toqui....
            })      
            
        // no volem refrescos
        $("#stop").click(function() {                
            clearInterval(interval);                
            })      
            
        // volem rebre ara mateix
        $("#rep").click(function() {                
            consultaDades();
            })                
			
		//mapa inici
		mymap = L.map('mapid').setView([41.39795, 2.18004], 13);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 12,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
				'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(mymap);

		//L.marker([51.5, -0.09]).addTo(mymap);
		// mapa fi			
			
     })
	 
	 function consultaDades() {        
        $.ajax({    url: 'http://wservice.viabicing.cat/v2/stations?format=json'})//http://wservice.viabicing.cat/v1/getstations.php?v=2?callback=?'})
            .done(function(data) {  console.log("ok");
                                    console.log(data);
                                    if (data.updateTime!=lastUpdateTime)
                                        { lastUpdateTime = data.updateTime;
                                          actualitzaDadesPantalla(data);
                                          actualitzaMapa(data);
                                          actualitzaGrafica(data);
                                          }
                                    })
            .fail(function (jqXHR, text, errorThrown) { console.log(jqXHR + "---" + text + "---" + errorThrown); console.log(jqXHR);})
            .always(function(x) { console.log( "Fí")});
        }                                    

    
    
    function actualitzaDadesPantalla(data)
    { arrayTipus = [];
      arrayBicisPerTipus = [];
      arraySlots = [];          

      var linea = "<p>Nova actualització <strong>" + lastUpdateTime + "</strong>";          

      //recorro array i vaig posant ja dades
      for (i=0;i<data.stations.length;i++)
       { isNaN(arrayTipus[data.stations[i].type])?arrayTipus[data.stations[i].type]=0:arrayTipus[data.stations[i].type]++;             
         isNaN(arrayBicisPerTipus[data.stations[i].type])?arrayBicisPerTipus[data.stations[i].type]=parseInt(data.stations[i].bikes):arrayBicisPerTipus[data.stations[i].type]+=parseInt(data.stations[i].bikes);
         isNaN(arraySlots[data.stations[i].type])?arraySlots[data.stations[i].type]=parseInt(data.stations[i].slots):arraySlots[data.stations[i].type]+=parseInt(data.stations[i].slots);
         }          
      for (tipo in arrayTipus) 
      { linea = linea + "<br>Estació tipus:" + tipo + " hi ha <strong>" +arrayTipus[tipo] + "</strong> estacions amb <strong>" + arrayBicisPerTipus[tipo] + "</strong> bicis disponibles i <strong>" + arraySlots[tipo] + "</strong> slots lliures.";
        }
      //afegueixo contingut dins html          
      $("#contingut").html(linea+ "</p>");          
    }   



    function actualitzaMapa(data) {
        if (data!==undefined) { 
            for (i = 0; i < data.stations.length; i++) {  //data.stations.length
        		L.marker([parseFloat(data.stations[i].latitude), parseFloat(data.stations[i].longitude)]).addTo(mymap);
                }
        	}          
        }
   
    
    
    function actualitzaGrafica(dada) {
        //https://developers.google.com/chart/interactive/docs/quick_start
        // Create the data table.
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Tipus');
        data.addColumn('number', 'Quantitat');
        if (dada!==undefined) { arrayTipus=[];
                                // compto numero d'estacions
                                for (i=0;i<dada.stations.length;i++)
                                    { isNaN(arrayTipus[dada.stations[i].type])?arrayTipus[dada.stations[i].type]=0:arrayTipus[dada.stations[i].type]++;     
                                        }
                                var rows=[];
                                for (tipo in arrayTipus) {
                                    rows.push([tipo,arrayTipus[tipo]]);
                                }
                                data.addRows(rows);
                                }       

        // Set chart options
        var options = {'title':'Quantitat d\'estacions per tipus',
                       'width':400,
                       'height':300};

        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.PieChart(document.getElementById('grafic'));
        chart.draw(data, options);
      }

</script>


	
</head>
<body>
    <body>
        <!-- modal segon, amb header, body i peu i dos botons un per tancar i l'altre per guardar       -->
        <!--              un camp per actualitzar la frequencia d'actualitzacio    -->
        <div class="modal fade" tabindex="-1" role="dialog" id="myModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Frequencia d'actualització</h4>
                        </div>
                    <div class="modal-body">
                        <label>Introdueix la nova freqüencia d'actualització</label><input id="myModalNovaFrequencia" type="number" max="500" min="1">                        
                        </div>
                    <div class="modal-footer">
                        <button type="buxamptton" class="btn btn-default" data-dismiss="modal">Tancar</button>
                        <button type="button" class="btn btn-primary" id="myModalGuardar">Actualitza</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
      <!-- Button trigger modal -->
      <header>  
          <div> Freqüència d'actualització actual : <strong id="frequencia">3</strong>
                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">Prem per canviar-la</button>
                <button type="button" class="btn btn-primary btn-lg" id="stop">Stop</button>
                <button type="button" class="btn btn-primary btn-lg" id="rep">Rep</button>               
                </div>
      </header>
      
      <article>
          <div id="contingut">TODO write content</div>
          <!-- per mostrar dades -->
      </article>
      
      <article>
          <div id="mapid" style="width: 600px; height: 400px;"></div>
           <div id="grafic"></div>          
      </article>
      
      
	  <article>
	  
	  </article>
    </body>
</html>
